!function(){const e=navigator.userAgent.toLowerCase(),n=["iphone","android","windows phone","blackberry","mobile","webos","opera mini","iemobile","mobile safari"];let t=!1;for(let o=0;o<n.length;o++)if(-1!==e.indexOf(n[o])){t=!0;break}}();let e=[{id:0,t:"00001",width:1959,height:1090,position:[-3.0089893469241797,-.11086489695181866,-3.7527640949141428],rotation:[[.876134201218856,.06925962026449776,.47706599800804744],[-.04747421839895102,.9972110940209488,-.057586739349882114],[-.4797239414934443,.027805376500959853,.8769787916452908]],fy:582.3300643742253,fx:1159.5880733038064}],n=3.141592653,t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];t=U(t,n/180*180,0,0,1),t=U(t,n/180*-20,0,1,0),t=U(t,n/180*-5,1,0,0);let o=[1,.5,-25],r=[[.7,.5,-12],[.7,.5,6]],i=[[1,2,13.2],[2,2,6]],a=0,c=0,l=0,s=5,u=-3,f=n/12,d=n,v=n/8,w=n/8;let h=0,m=o;function p(){c+=l*w,l=0}function y(e){let n=x([a,c+l*w,0]);return n[12]=e[0],n[13]=e[1],n[14]=e[2],n}function x(e){const n=e[0],t=e[1],o=e[2],r=Math.cos(n),i=Math.sin(n),a=Math.cos(t),c=Math.sin(t),l=Math.cos(o),s=Math.sin(o);let u=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],f=a*l,d=a*s,v=c*l,w=c*s;return u[0]=f+w*i,u[4]=v*i-d,u[8]=r*c,u[1]=r*s,u[5]=r*l,u[9]=-i,u[2]=d*i-v,u[6]=w+f*i,u[10]=r*a,u}let g=e[0];function A(e,n,t,o){const r=200;return[[2*e/t,0,0,0],[0,-2*n/o,0,0],[0,0,r/199.8,1],[0,0,-40/199.8,0]].flat()}function b(e,n){return[n[0]*e[0]+n[1]*e[4]+n[2]*e[8]+n[3]*e[12],n[0]*e[1]+n[1]*e[5]+n[2]*e[9]+n[3]*e[13],n[0]*e[2]+n[1]*e[6]+n[2]*e[10]+n[3]*e[14],n[0]*e[3]+n[1]*e[7]+n[2]*e[11]+n[3]*e[15],n[4]*e[0]+n[5]*e[4]+n[6]*e[8]+n[7]*e[12],n[4]*e[1]+n[5]*e[5]+n[6]*e[9]+n[7]*e[13],n[4]*e[2]+n[5]*e[6]+n[6]*e[10]+n[7]*e[14],n[4]*e[3]+n[5]*e[7]+n[6]*e[11]+n[7]*e[15],n[8]*e[0]+n[9]*e[4]+n[10]*e[8]+n[11]*e[12],n[8]*e[1]+n[9]*e[5]+n[10]*e[9]+n[11]*e[13],n[8]*e[2]+n[9]*e[6]+n[10]*e[10]+n[11]*e[14],n[8]*e[3]+n[9]*e[7]+n[10]*e[11]+n[11]*e[15],n[12]*e[0]+n[13]*e[4]+n[14]*e[8]+n[15]*e[12],n[12]*e[1]+n[13]*e[5]+n[14]*e[9]+n[15]*e[13],n[12]*e[2]+n[13]*e[6]+n[14]*e[10]+n[15]*e[14],n[12]*e[3]+n[13]*e[7]+n[14]*e[11]+n[15]*e[15]]}function M(e){let n=e[0]*e[5]-e[1]*e[4],t=e[0]*e[6]-e[2]*e[4],o=e[0]*e[7]-e[3]*e[4],r=e[1]*e[6]-e[2]*e[5],i=e[1]*e[7]-e[3]*e[5],a=e[2]*e[7]-e[3]*e[6],c=e[8]*e[13]-e[9]*e[12],l=e[8]*e[14]-e[10]*e[12],s=e[8]*e[15]-e[11]*e[12],u=e[9]*e[14]-e[10]*e[13],f=e[9]*e[15]-e[11]*e[13],d=e[10]*e[15]-e[11]*e[14],v=n*d-t*f+o*u+r*s-i*l+a*c;return v?[(e[5]*d-e[6]*f+e[7]*u)/v,(e[2]*f-e[1]*d-e[3]*u)/v,(e[13]*a-e[14]*i+e[15]*r)/v,(e[10]*i-e[9]*a-e[11]*r)/v,(e[6]*s-e[4]*d-e[7]*l)/v,(e[0]*d-e[2]*s+e[3]*l)/v,(e[14]*o-e[12]*a-e[15]*t)/v,(e[8]*a-e[10]*o+e[11]*t)/v,(e[4]*f-e[5]*s+e[7]*c)/v,(e[1]*s-e[0]*f-e[3]*c)/v,(e[12]*i-e[13]*o+e[15]*n)/v,(e[9]*o-e[8]*i-e[11]*n)/v,(e[5]*l-e[4]*u-e[6]*c)/v,(e[0]*u-e[1]*l+e[2]*c)/v,(e[13]*t-e[12]*r-e[14]*n)/v,(e[8]*r-e[9]*t+e[10]*n)/v]:null}function U(e,n,t,o,r){let i=Math.hypot(t,o,r);t/=i,o/=i,r/=i;let a=Math.sin(n),c=Math.cos(n),l=1-c,s=t*t*l+c,u=o*t*l+r*a,f=r*t*l-o*a,d=t*o*l-r*a,v=o*o*l+c,w=r*o*l+t*a,h=t*r*l+o*a,m=o*r*l-t*a,p=r*r*l+c;return[e[0]*s+e[4]*u+e[8]*f,e[1]*s+e[5]*u+e[9]*f,e[2]*s+e[6]*u+e[10]*f,e[3]*s+e[7]*u+e[11]*f,e[0]*d+e[4]*v+e[8]*w,e[1]*d+e[5]*v+e[9]*w,e[2]*d+e[6]*v+e[10]*w,e[3]*d+e[7]*v+e[11]*w,e[0]*h+e[4]*m+e[8]*p,e[1]*h+e[5]*m+e[9]*p,e[2]*h+e[6]*m+e[10]*p,e[3]*h+e[7]*m+e[11]*p,...e.slice(12,16)]}function C(e,n,t,o){return[...e.slice(0,12),e[0]*n+e[4]*t+e[8]*o+e[12],e[1]*n+e[5]*t+e[9]*o+e[13],e[2]*n+e[6]*t+e[10]*o+e[14],e[3]*n+e[7]*t+e[11]*o+e[15]]}const F=new Uint8Array([31,47,63]);function _(e,n){const t=new Uint8Array(e.length);for(let o=0;o<e.length;o++)t[o]=e[o]^n[o%n.length];return t}function z(e){let n,t,o=0;let r=[],i=new Uint32Array,a=0;var c=new Float32Array(1),l=new Int32Array(c.buffer);function s(e){c[0]=e;var n,t=l[0],o=t>>23&255,r=8388607&t;return 0==o?n=0:o<113?(n=0,r|=8388608,16777216&(r>>=113-o)&&(n=1,r=0)):o<142?n=o-112:(n=31,r=0),(t>>31&1)<<15|n<<10|r>>13}function u(e,n){return(s(e)|s(n)<<16)>>>0}function f(t){if(!n)return;const c=new Float32Array(n);if(a==o){let e=r[2]*t[2]+r[6]*t[6]+r[10]*t[10];if(Math.abs(e-1)<.01)return}else!function(){if(!n)return;const t=new Float32Array(n),r=new Uint8Array(n);var i=2048,a=Math.ceil(2*o/i),c=new Uint32Array(i*a*4),l=new Uint8Array(c.buffer),s=new Float32Array(c.buffer);for(let e=0;e<o;e++){s[8*e+0]=t[8*e+0],s[8*e+1]=t[8*e+1],s[8*e+2]=t[8*e+2],l[4*(8*e+7)+0]=r[32*e+24+0],l[4*(8*e+7)+1]=r[32*e+24+1],l[4*(8*e+7)+2]=r[32*e+24+2],l[4*(8*e+7)+3]=r[32*e+24+3];let n=[t[8*e+3+0],t[8*e+3+1],t[8*e+3+2]],o=[(r[32*e+28+0]-128)/128,(r[32*e+28+1]-128)/128,(r[32*e+28+2]-128)/128,(r[32*e+28+3]-128)/128];const i=[1-2*(o[2]*o[2]+o[3]*o[3]),2*(o[1]*o[2]+o[0]*o[3]),2*(o[1]*o[3]-o[0]*o[2]),2*(o[1]*o[2]-o[0]*o[3]),1-2*(o[1]*o[1]+o[3]*o[3]),2*(o[2]*o[3]+o[0]*o[1]),2*(o[1]*o[3]+o[0]*o[2]),2*(o[2]*o[3]-o[0]*o[1]),1-2*(o[1]*o[1]+o[2]*o[2])].map(((e,t)=>e*n[Math.floor(t/3)])),a=[i[0]*i[0]+i[3]*i[3]+i[6]*i[6],i[0]*i[1]+i[3]*i[4]+i[6]*i[7],i[0]*i[2]+i[3]*i[5]+i[6]*i[8],i[1]*i[1]+i[4]*i[4]+i[7]*i[7],i[1]*i[2]+i[4]*i[5]+i[7]*i[8],i[2]*i[2]+i[5]*i[5]+i[8]*i[8]];c[8*e+4]=u(4*a[0],4*a[1]),c[8*e+5]=u(4*a[2],4*a[3]),c[8*e+6]=u(4*a[4],4*a[5])}e.postMessage({o:c,i:i,l:a},[c.buffer])}(),a=o;let l=-1/0,s=1/0,f=new Int32Array(o);for(let e=0;e<o;e++){let n=4096*(t[2]*c[8*e+0]+t[6]*c[8*e+1]+t[10]*c[8*e+2])|0;f[e]=n,n>l&&(l=n),n<s&&(s=n)}let d=65536/(l-s),v=new Uint32Array(65536);for(let e=0;e<o;e++)f[e]=(f[e]-s)*d|0,v[f[e]]++;let w=new Uint32Array(65536);for(let e=1;e<65536;e++)w[e]=w[e-1]+v[e-1];i=new Uint32Array(o);for(let e=0;e<o;e++)i[w[f[e]]++]=e;r=t,e.postMessage({u:i,v:t,h:o},[i.buffer])}const d=()=>{if(!v){v=!0;let e=t;f(e),setTimeout((()=>{v=!1,e!==t&&d()}),0)}};let v;e.onmessage=e=>{e.data.m?(o=0,f(t),n=function(e){const n=new Uint8Array(e),t=(new TextDecoder).decode(n.slice(0,10240)),o="end_header\n",r=t.indexOf(o);if(r<0)throw new Error("Unable to read .ply file header");const i=parseInt(/element vertex (\d+)\n/.exec(t)[1]);console.log("Vertex Count",i);let a=0,c={},l={};const s={p:"getFloat64",A:"getInt32",M:"getUint32",float:"getFloat32",U:"getInt16",C:"getUint16",F:"getUint8"};for(let e of t.slice(0,r).split("\n").filter((e=>e.startsWith("property ")))){const[n,t,o]=e.split(" "),r=s[t]||"getInt8";l[o]=r,c[o]=a,a+=parseInt(r.replace(/[^\d]/g,""))/8}console.log("Bytes per row",a,l,c);let u=new DataView(e,r+11),f=0;const d=new Proxy({},{get(e,n){if(!l[n])throw new Error(n+" not found");return u[l[n]](f*a+c[n],!0)}});console.time("calculate importance");let v=new Float32Array(i),w=new Uint32Array(i);for(f=0;f<i;f++){if(w[f]=f,!l._)continue;const e=Math.exp(d._)*Math.exp(d.P)*Math.exp(d.R),n=1/(1+Math.exp(-d.opacity));v[f]=e*n}console.timeEnd("calculate importance"),console.time("sort"),w.sort(((e,n)=>v[n]-v[e])),console.timeEnd("sort");const h=new ArrayBuffer(32*i);console.time("build buffer");for(let e=0;e<i;e++){f=w[e];const n=new Float32Array(h,32*e,3),t=new Float32Array(h,32*e+12,3),o=new Uint8ClampedArray(h,32*e+12+12,4),r=new Uint8ClampedArray(h,32*e+12+12+4,4);if(l._){const e=Math.sqrt(d.k**2+d.H**2+d.I**2+d.D**2);r[0]=d.k/e*128+128,r[1]=d.H/e*128+128,r[2]=d.I/e*128+128,r[3]=d.D/e*128+128,t[0]=Math.exp(d._),t[1]=Math.exp(d.P),t[2]=Math.exp(d.R)}else t[0]=.01,t[1]=.01,t[2]=.01,r[0]=255,r[1]=0,r[2]=0,r[3]=0;if(n[0]=d.x,n[1]=d.y,n[2]=d.z,l.j){const e=.28209479177387814;o[0]=255*(.5+e*d.j),o[1]=255*(.5+e*d.B),o[2]=255*(.5+e*d.L)}else o[0]=d.red,o[1]=d.green,o[2]=d.blue;l.opacity?o[3]=1/(1+Math.exp(-d.opacity))*255:o[3]=255}return console.timeEnd("build buffer"),h}(e.data.m),o=Math.floor(n.byteLength/32),postMessage({buffer:n})):e.data.buffer?(n=e.data.buffer,o=e.data.h):e.data.h?o=e.data.h:e.data.view&&(t=e.data.view,d())}}const P="\n#version 300 es\nprecision highp float;\nprecision highp int;\n\nuniform highp usampler2D u_texture;\nuniform mat4 projection, view;\nuniform vec2 focal;\nuniform vec2 viewport;\n\nin vec2 position;\nin int index;\n\nout vec4 vColor;\nout vec2 vPosition;\nout vec4 test;\n\nvoid main () {\n    uvec4 cen = texelFetch(u_texture, ivec2((uint(index) & 0x3ffu) << 1, uint(index) >> 10), 0);\n    vec4 cam = view * vec4(uintBitsToFloat(cen.xyz), 1);\n    vec4 pos2d = projection * cam;\n\n    float clip = 1.2 * pos2d.w;\n    if (pos2d.z < -clip || pos2d.x < -clip || pos2d.x > clip || pos2d.y < -clip || pos2d.y > clip) {\n        gl_Position = vec4(0.0, 0.0, 2.0, 1.0);\n        return;\n    }\n\n    uvec4 cov = texelFetch(u_texture, ivec2(((uint(index) & 0x3ffu) << 1) | 1u, uint(index) >> 10), 0);\n    vec2 u1 = unpackHalf2x16(cov.x), u2 = unpackHalf2x16(cov.y), u3 = unpackHalf2x16(cov.z);\n    mat3 Vrk = mat3(u1.x, u1.y, u2.x, u1.y, u2.y, u3.x, u2.x, u3.x, u3.y);\n\n    mat3 J = mat3(\n        focal.x / cam.z, 0., -(focal.x * cam.x) / (cam.z * cam.z), \n        0., -focal.y / cam.z, (focal.y * cam.y) / (cam.z * cam.z), \n        0., 0., 0.\n    );\n\n    mat3 T = transpose(mat3(view)) * J;\n    mat3 cov2d = transpose(T) * Vrk * T;\n\n    float mid = (cov2d[0][0] + cov2d[1][1]) / 2.0;\n    float radius = length(vec2((cov2d[0][0] - cov2d[1][1]) / 2.0, cov2d[0][1]));\n    float lambda1 = mid + radius, lambda2 = mid - radius;\n\n    if(lambda2 < 0.0) return;\n    vec2 diagonalVector = normalize(vec2(cov2d[0][1], lambda1 - cov2d[0][0]));\n    vec2 majorAxis = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;\n    vec2 minorAxis = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);\n\n    //vColor = clamp(pos2d.z/pos2d.w+1.0, 0.0, 1.0) * vec4((cov.w) & 0xffu, (cov.w >> 8) & 0xffu, (cov.w >> 16) & 0xffu, (cov.w >> 24) & 0xffu) / 255.0;\n    vColor = vec4((cov.w) & 0xffu, (cov.w >> 8) & 0xffu, (cov.w >> 16) & 0xffu, (cov.w >> 24) & 0xffu) / 255.0;\n    \n    vPosition = position;\n\n    vec2 vCenter = vec2(pos2d) / pos2d.w;\n    test = vec4(pos2d.z);\n    gl_Position = vec4(\n        vCenter \n        + position.x * majorAxis / viewport \n        + position.y * minorAxis / viewport, 0.0, 1.0);\n\n\n}\n".trim(),R="\n#version 300 es\nprecision highp float;\n\nin vec4 vColor;\nin vec2 vPosition;\nin vec4 test;\n\nout vec4 fragColor;\n\nvoid main () {\n    // fragColor = vec4(test.z*0.1, 0.0,0.0,1.0);\n\n    float blur_ratio = test.z / 15.0;\n    if(blur_ratio < 0.0) blur_ratio = 0.0;\n    if(blur_ratio > 1.0) blur_ratio = 1.0;\n\n    float A = -dot(vPosition, vPosition);\n    if (A < -4.0) discard;\n    // if(vColor.a < 0.2) discard;\n    float B = exp(A/(1.0+blur_ratio*0.5)) * vColor.a;\n    // float B = vColor.a;\n    fragColor = vec4(B * vColor.rgb, B);\n}\n\n".trim();(async function(){let w=true;const x=new URLSearchParams(location.search);try{M(JSON.parse(decodeURIComponent(location.hash.slice(1))));w=!1}catch(e){}const U=new URL(window.location.href).href,k=U.endsWith("/")?U.slice(0,-1):U,H=k.substring(0,k.lastIndexOf("/"))+"/models/",I=new URL(x.get("url")||"output.splat.enc",H),D=await fetch(I,{mode:"cors",credentials:"omit"});if(console.log("get models request: "+D),200!=D.status)throw new Error(D.status+" Unable to load "+D.url);const j=32,B=D.body.getReader();let L=new Uint8Array(D.headers.get("content-length"));const S=(L.length/j>5e5?1:1/devicePixelRatio)/1;console.log("modelData length: "+L.length/j," down sample: "+S);const V=new Worker(URL.createObjectURL(new Blob(["(",z.toString(),")(self)"],{type:"application/javascript"}))),E=document.getElementById("canvas");let J;const T=E.getContext("webgl2",{antialias:!1}),W=T.createShader(T.VERTEX_SHADER);T.shaderSource(W,P),T.compileShader(W),T.getShaderParameter(W,T.COMPILE_STATUS)||console.error(" VERTEX_SHADER create error: "+T.getShaderInfoLog(W));const K=T.createShader(T.FRAGMENT_SHADER);T.shaderSource(K,R),T.compileShader(K),T.getShaderParameter(K,T.COMPILE_STATUS)||console.error(" FRAGMENT_SHADER create error: "+T.getShaderInfoLog(K));const N=T.createProgram();T.attachShader(N,W),T.attachShader(N,K),T.linkProgram(N),T.useProgram(N),T.getProgramParameter(N,T.LINK_STATUS)||console.error(" createProgram error: "+T.getProgramInfoLog(N)),T.disable(T.DEPTH_TEST),T.enable(T.BLEND),T.blendFuncSeparate(T.ONE_MINUS_DST_ALPHA,T.ONE,T.ONE_MINUS_DST_ALPHA,T.ONE),T.blendEquationSeparate(T.FUNC_ADD,T.FUNC_ADD);const $=T.getUniformLocation(N,"projection"),q=T.getUniformLocation(N,"viewport"),G=T.getUniformLocation(N,"focal"),O=T.getUniformLocation(N,"view"),X=new Float32Array([-2,-2,2,-2,2,2,-2,2]),Q=T.createBuffer();T.bindBuffer(T.ARRAY_BUFFER,Q),T.bufferData(T.ARRAY_BUFFER,X,T.STATIC_DRAW);const Y=T.getAttribLocation(N,"position");T.enableVertexAttribArray(Y),T.bindBuffer(T.ARRAY_BUFFER,Q),T.vertexAttribPointer(Y,2,T.FLOAT,!1,0,0);var Z=T.createTexture();T.bindTexture(T.TEXTURE_2D,Z);var ee=T.getUniformLocation(N,"u_texture");T.uniform1i(ee,0);const ne=T.createBuffer(),te=T.getAttribLocation(N,"index");T.enableVertexAttribArray(te),T.bindBuffer(T.ARRAY_BUFFER,ne),T.vertexAttribIPointer(te,1,T.INT,!1,0),T.vertexAttribDivisor(te,1);const oe=()=>{let e=1*innerHeight,n=1*innerHeight;T.uniform2fv(G,new Float32Array([e,n])),J=A(e,n,innerWidth,innerHeight),T.uniform2fv(q,new Float32Array([innerWidth,innerHeight])),T.canvas.width=Math.round(innerWidth/S),T.canvas.height=Math.round(innerHeight/S),T.viewport(0,0,T.canvas.width,T.canvas.height),T.uniformMatrix4fv($,!1,J)};window.addEventListener("resize",oe),oe(),V.onmessage=e=>{if(e.data.buffer){console.log("main buffer"),L=new Uint8Array(e.data.buffer);const n=new Blob([L.buffer],{type:"application/octet-stream"}),t=document.createElement("a");t.download="models.splat",t.href=URL.createObjectURL(n),document.body.appendChild(t),t.click()}else if(e.data.o){const{o:n,i:t,l:o}=e.data;T.bindTexture(T.TEXTURE_2D,Z),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_S,T.CLAMP_TO_EDGE),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_T,T.CLAMP_TO_EDGE),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MIN_FILTER,T.NEAREST),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MAG_FILTER,T.NEAREST),T.texImage2D(T.TEXTURE_2D,0,T.RGBA32UI,t,o,0,T.RGBA_INTEGER,T.UNSIGNED_INT,n),T.activeTexture(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,Z)}else if(e.data.u){const{u:n,v:t}=e.data;T.bindBuffer(T.ARRAY_BUFFER,ne),T.bufferData(T.ARRAY_BUFFER,n,T.DYNAMIC_DRAW),le=e.data.h}};let re,ie,ae,ce=[];window.addEventListener("keydown",(e=>{w=!1,p(),ce.includes(e.code)||ce.push(e.code),"KeyP"===e.code&&(w=!0)})),window.addEventListener("keyup",(e=>{ce=ce.filter((n=>n!==e.code))})),window.addEventListener("blur",(()=>{ce=[]})),E.addEventListener("mousedown",(e=>{w=!1,p(),e.preventDefault(),re=e.clientX,ie=e.clientY,ae=e.ctrlKey||e.metaKey?2:1})),E.addEventListener("contextmenu",(e=>{w=!1,p(),e.preventDefault(),re=e.clientX,ie=e.clientY,ae=2})),E.addEventListener("mousemove",(e=>{if(e.preventDefault(),1==ae){let n=2*(e.clientX-re)/innerWidth,t=2*(e.clientY-ie)/innerHeight;a+=-t,c+=n,re=e.clientX,ie=e.clientY}else 2==ae&&(re=e.clientX,ie=e.clientY)})),E.addEventListener("mouseup",(e=>{e.preventDefault(),ae=!1,re=0,ie=0})),E.addEventListener("touchstart",(e=>{e.preventDefault(),1===e.touches.length?(w=!1,p(),re=e.touches[0].clientX,ie=e.touches[0].clientY,ae=1):2===e.touches.length&&(w=!1,p())}),{passive:!1}),E.addEventListener("touchmove",(e=>{if(e.preventDefault(),1===e.touches.length&&ae){let n=1*(e.touches[0].clientX-re)/innerWidth,t=1*(e.touches[0].clientY-ie)/innerHeight;a+=t,c+=-n,re=e.touches[0].clientX,ie=e.touches[0].clientY}else e.touches.length}),{passive:!1}),E.addEventListener("touchend",(e=>{e.preventDefault(),ae=!1,re=0,ie=0}),{passive:!1});let le=0,se=0,ue=0,fe=0;window.addEventListener("gamepadconnected",(e=>{const n=navigator.getGamepads()[e.gamepad.index];console.log(`Gamepad connected at index ${n.index}: ${n.id}. It has ${n.buttons.length} buttons and ${n.axes.length} axes.`)})),window.addEventListener("gamepaddisconnected",(e=>{console.log("Gamepad disconnected")}));const de=e=>{let x=ce.includes("Shift")||ce.includes("ShiftLeft")||ce.includes("ShiftRight"),g=y(o);if(ce.includes("ArrowUp"))if(x)g[13]-=-.09;else{let e=g[13];g=C(g,0,0,.09),g[13]=e}if(ce.includes("ArrowDown"))if(x)g[13]-=.09;else{let e=g[13];g=C(g,0,0,-.09),g[13]=e}if(ce.includes("ArrowLeft")){let e=g[13];g=C(g,-.09,0,0),g[13]=e}if(ce.includes("ArrowRight")){let e=g[13];g=C(g,.09,0,0),g[13]=e}ce.includes("KeyS")&&(a+=-.01),ce.includes("KeyW")&&(a+=.01),ce.includes("KeyD")&&(c+=.01),ce.includes("KeyA")&&(c+=-.01);if(Math.abs(Joy3.GetX())>.1){let e=g[13];g=C(g,.001*Joy3.GetX(),0,0),g[13]=e,w=!1,p()}if(Math.abs(Joy3.GetY())>.1){let e=g[13];g=C(g,0,0,.001*Joy3.GetY()),g[13]=e,w=!1,p()}o=[g[12],g[13],g[14]],l=w?Math.sin((Date.now()-fe)/5e3):0,g=function(){let e=o[0],t=o[1],l=o[2],w=-1,p=-1,x=-1,g=!1;for(let n=0;n<r.length;n++){let o=r[n][0],a=r[n][1],c=r[n][2],s=i[n][0],u=i[n][1],f=i[n][2];if(Math.abs(e-o)<=s&&Math.abs(t-a)<=u&&Math.abs(l-c)<=f){g=!0,w=e,p=t,x=l,h=n;break}}if(!g){let n=r[h][0],o=r[h][1],a=r[h][2],c=i[h][0],s=i[h][1],u=i[h][2];w=e-n>c?n+c:e-n<-c?n-c:e,p=t-o>s?o+s:t-o<-s?o-s:t,x=l-a>u?a+u:l-a<-u?a-u:l}o[0]=w,o[1]=p,o[2]=x,a>f&&(a=f),a<-f&&(a=-f);let A=(o[2]-u)/(s-u);A>1&&(A=1),A<0&&(A=0),A=A*(d-v)+v,c>n&&(c-=2*n),c<-n&&(c+=2*n),c>A&&(c=A),c<-A&&(c=-A);let b=y(o);return m=o,b}();let A=b(M(g),t);const U=b(J,A);V.postMessage({view:U});ue=.9*ue+.1*(1e3/(e-se)||0),le>0?(document.getElementById("spinner").style.display="none",T.uniformMatrix4fv(O,!1,A),T.clear(T.COLOR_BUFFER_BIT),T.drawArraysInstanced(T.TRIANGLE_FAN,0,4,le)):(T.clear(T.COLOR_BUFFER_BIT),document.getElementById("spinner").style.display="",fe=Date.now()+2e3);const F=100*le/(L.length/j);F<100?document.getElementById("progress").style.width=F+"%":document.getElementById("progress").style.display="none",isNaN(0),se=e,requestAnimationFrame(de)};de(),window.addEventListener("hashchange",(e=>{try{w=!1,p()}catch(e){}}));const ve=e=>{e.preventDefault(),e.stopPropagation()};document.addEventListener("dragenter",ve),document.addEventListener("dragover",ve),document.addEventListener("dragleave",ve),document.addEventListener("drop",(n=>{n.preventDefault(),n.stopPropagation(),(n=>{const t=new FileReader;/\.json$/i.test(n.name)?(t.onload=()=>{e=JSON.parse(t.result),function(e){const n=e.rotation.flat(),t=e.position;[[n[0],n[1],n[2],0],[n[3],n[4],n[5],0],[n[6],n[7],n[8],0],[-t[0]*n[0]-t[1]*n[3]-t[2]*n[6],-t[0]*n[1]-t[1]*n[4]-t[2]*n[7],-t[0]*n[2]-t[1]*n[5]-t[2]*n[8],1]].flat()}(e[0]),J=A(g.fx/S,g.fy/S,E.width,E.height),T.uniformMatrix4fv($,!1,J),console.log("Loaded Cameras")},t.readAsText(n)):(me=!0,t.onload=()=>{L=new Uint8Array(t.result),console.log("Loaded",Math.floor(L.length/j)),112==L[0]&&108==L[1]&&121==L[2]&&10==L[3]?V.postMessage({m:L.buffer}):V.postMessage({buffer:L.buffer,h:Math.floor(L.length/j)})},t.readAsArrayBuffer(n))})(n.dataTransfer.files[0])}));let we=0,he=-1,me=!1;for(;;){const{done:e,value:n}=await B.read();if(e||me)break;L.set(n,we),we+=n.length;const t=_(new Uint8Array(L.buffer),F);le>he&&(V.postMessage({buffer:t.buffer,h:Math.floor(we/j)}),he=le)}if(!me){const e=_(new Uint8Array(L.buffer),F);V.postMessage({buffer:e.buffer,h:Math.floor(we/j)})}})().catch((e=>{document.getElementById("spinner").style.display="none",document.getElementById("message").innerText=e.toString()}));